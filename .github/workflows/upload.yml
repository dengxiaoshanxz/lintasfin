name: Upload AppStore
on:
  push:
    branches: [main]
  workflow_dispatch:  # 允许手动触发

jobs:
  call-api:
    runs-on: macOS-latest
    env:
      ALL_PROXY: socks5://l8U68dd37677980c:PElAqjSN4Q18tnb0Id@202.155.131.35:45001
      FASTLANE_DISABLE_UPDATE_CHECK: "1"   # 新增：禁用 fastlane 更新检查
    steps:
      # 配置 Git 使用代理（关键！）
      - name: Configure Git Proxy
        run: |
          git config --global http.proxy "socks5://l8U68dd37677980c:PElAqjSN4Q18tnb0Id@202.155.131.35:45001"
          git config --global https.proxy "socks5://l8U68dd37677980c:PElAqjSN4Q18tnb0Id@202.155.131.35:45001"
    
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.5      # 固定到 3.1.x，避免 runner 上的 3.4 导致兼容问题
          bundler-cache: true

      - name: Install Bundler & Dependencies
        run: |
          gem install bundler
          bundle install

      # 注意：已移除自动执行 `bundle update fastlane abbrev`，避免升级到不兼容的 fastlane/依赖

      - name: Print current IP before setting proxy
        run: curl ifconfig.me

      - name: Upload IPA to App Store Connect
        env:
          ALL_PROXY: socks5://l8U68dd37677980c:PElAqjSN4Q18tnb0Id@202.155.131.35:45001
          FASTLANE_DISABLE_UPDATE_CHECK: "1"   # 再次在该 step 明确设置（可选）
        run: |
          echo "Using proxy: $ALL_PROXY"
          bundle exec fastlane ios upload
        
      - name: Print current IP after uploading
        run: curl ifconfig.me
